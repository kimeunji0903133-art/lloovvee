<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì „ì—°ì¸ ì‹œë®¬ë ˆì´í„° - í˜„ì‹¤ ì‹¤ì‚¬ ê²Œì„í˜•</title>
<style>
  :root{
    --bg:#fff6fb;
    --card:rgba(255,255,255,0.85);
    --primary:#ff6fa3;
    --muted:#8b6b6b;
    --radius:16px;
    --glass: rgba(255,255,255,0.65);
    font-family: "Noto Sans KR","Helvetica Neue",Arial,sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#fff6fb,#fff0f3);color:#222}
  .container{max-width:1000px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr 320px;gap:14px;}
  @media(max-width:920px){.container{grid-template-columns:1fr} .sidebar{order:2}}
  header{grid-column:1/-1;display:flex;align-items:center;gap:12px}
  header h1{margin:0;font-size:1.4rem;color:var(--primary)}
  .game-area{position:relative;border-radius:20px;overflow:hidden;height:640px;box-shadow:0 12px 30px rgba(20,10,30,0.12)}
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(0.85) saturate(0.96);}
  .overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.25));}
  .ui {position:absolute;inset:18px;display:flex;gap:12px;align-items:flex-end;pointer-events:none;padding-bottom:22px}
  .left-column{flex:1;display:flex;flex-direction:column;gap:12px;pointer-events:auto}
  .card{background:var(--card);backdrop-filter: blur(6px);border-radius:14px;padding:12px;box-shadow:0 8px 22px rgba(10,10,20,0.08)}
  .chat{height:340px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
  .npc-msg, .player-msg{max-width:78%;padding:10px 12px;border-radius:12px;display:flex;gap:10px;align-items:center}
  .npc-msg{background:rgba(255,255,255,0.95);color:#222;align-self:flex-start}
  .player-msg{background:linear-gradient(90deg,var(--primary),#ff8abb);color:#fff;align-self:flex-end}
  .npc-msg img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .choices button{pointer-events:auto;border:none;padding:10px 12px;border-radius:10px;background:#fff;cursor:pointer;text-align:left;font-weight:600}
  .choices button.extreme{background:linear-gradient(90deg,#ffe6ef,#ffb6d0);color:#300}
  .choices button.calm{background:linear-gradient(90deg,#f0f7ff,#dff0ff)}
  .stage{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .stats{display:flex;flex-direction:column;gap:8px}
  .stat-row{display:flex;align-items:center;gap:8px;font-size:0.9rem}
  .bar{height:10px;background:#eee;border-radius:999px;flex:1;overflow:hidden}
  .fill{height:100%;border-radius:999px;transition:width 0.35s}
  .love{background:linear-gradient(90deg,#ffd6e9,#ff6fa3)}
  .anger{background:linear-gradient(90deg,#ffdcb3,#ff7b4b)}
  .sad{background:linear-gradient(90deg,#dbeaff,#7aa7ff)}
  .right-panel{display:flex;flex-direction:column;gap:12px;pointer-events:auto}
  .progress{height:12px;background:rgba(255,255,255,0.6);border-radius:10px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#ffd6e9,#ffd6e9);width:0%}
  footer{grid-column:1/-1;text-align:center;font-size:0.85rem;color:var(--muted);margin-top:6px}
  .top-controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:none;background:var(--primary);color:#fff;cursor:pointer}
  .small{font-size:0.85rem;padding:6px 8px}
  .ending-screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));color:#fff;z-index:40}
  .ending-card{background:rgba(255,255,255,0.06);padding:22px;border-radius:14px;text-align:center;max-width:520px}
  .download-btn{background:#fff;color:#333;padding:10px 14px;border-radius:10px;margin-top:10px}
  /* responsive tweaks */
  @media(max-width:520px){
    .game-area{height:76vh}
    .chat{height:220px}
    .npc-msg img{width:40px;height:40px}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ì „ì—°ì¸ ì‹œë®¬ë ˆì´í„° â€” í˜„ì‹¤ ì‹¤ì‚¬ ê²Œì„í˜•</h1>
    <div style="flex:1"></div>
    <div class="top-controls">
      <button class="btn small" id="saveBtn">ì €ì¥</button>
      <button class="btn small" id="restartBtn">ì²˜ìŒë¶€í„°</button>
    </div>
  </header>

  <div class="game-area card" id="game">
    <div class="bg" id="bg"></div>
    <div class="overlay"></div>

    <div class="ui">
      <div class="left-column">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong id="sceneTitle">Scene</strong>
            <div style="font-size:0.85rem;color:var(--muted)" id="sceneInfo">Stage 1 / 15</div>
          </div>
          <div class="chat" id="chat"></div>
        </div>

        <div class="card">
          <div id="choices"></div>
        </div>
      </div>

      <aside class="right-panel">
        <div class="card stats">
          <div class="stat-row"><strong>ê°ì • ìƒíƒœ</strong></div>
          <div class="stat-row"><span>ğŸ’— ì‚¬ë‘</span><div class="bar"><div id="loveBar" class="fill love" style="width:50%"></div></div></div>
          <div class="stat-row"><span>ğŸ’¢ ë¶„ë…¸</span><div class="bar"><div id="angerBar" class="fill anger" style="width:20%"></div></div></div>
          <div class="stat-row"><span>ğŸ’§ ìŠ¬í””</span><div class="bar"><div id="sadBar" class="fill sad" style="width:30%"></div></div></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>ì§„í–‰</strong>
            <span id="stageText" style="color:var(--muted)">0 / 0</span>
          </div>
          <div class="progress" style="margin-top:8px;"><i id="progressFill" style="width:0%"></i></div>
          <div style="margin-top:10px;text-align:center">
            <button class="btn small" id="autoPlay">ìë™ ì§„í–‰</button>
          </div>
        </div>

        <div class="card">
          <strong>ë©”ëª¨</strong>
          <div style="font-size:0.9rem;color:var(--muted);margin-top:6px">ê²°ê³¼ëŠ” ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì œì¶œ/ë³´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <div style="margin-top:10px;display:flex;gap:6px">
            <button class="btn small" id="downloadBtn">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn small" id="clearBtn" style="background:#aaa">ì €ì¥ ì·¨ì†Œ</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <footer>ì œì‘: ì „ì—°ì¸ ì‹œë®¬ë ˆì´í„° â€” í˜„ì‹¤ ì‹¤ì‚¬ ë²„ì „ Â· êµìœ¡ìš© / ì‹œë²”ìš©</footer>
</div>

<!-- ì—”ë”© ëª¨ë‹¬ -->
<div id="ending" class="ending-screen" style="display:none">
  <div class="ending-card">
    <h2 id="endingTitle">ì—”ë”©</h2>
    <p id="endingDesc"></p>
    <div style="margin-top:12px">
      <button id="restart2" class="btn">ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</button>
      <button id="download2" class="download-btn">ì¼ê¸° ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<script>
/* ============================
   DATA: scenes (15+) with real-photo backgrounds
   - ê° ì¥ë©´ì€: title, text, bg (ì‹¤ì‚¬ ì´ë¯¸ì§€), npc (ì‚¬ëŒ ì–¼êµ´ ì´ë¯¸ì§€), choices[]
   - choice: {text, effect: {love, anger, sad}, type: 'extreme'|'calm'|'neutral'}
   ============================ */
const scenes = [
  {title:"ìš°ì—°í•œ ì—°ë½", text:"ì˜¤ëœë§Œì´ì•¼. ê°‘ìê¸° ìƒê°ë‚˜ì„œ ì—°ë½í–ˆì–´.", bg:"https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ë°˜ê°€ì›Œ! ì˜ ì§€ëƒˆì–´?", effect:{love:8,anger:-4,sad:-2}, type:"calm"},
    {text:"ì™œ ì´ì œ ì™€ì„œ...?", effect:{love:-6,anger:6,sad:2}, type:"extreme"},
    {text:"(ë¬µë¬µíˆ ë¬´ì‹œí•œë‹¤)", effect:{love:-4,anger:2,sad:4}, type:"neutral"}
  ]},
  {title:"ì¶”ì–µ ì†Œí™˜", text:"ì§€ë‚œë²ˆ ìš°ë¦¬ ê°™ì´ ê°”ë˜ ì¹´í˜ ì‚¬ì§„ ë´¤ì–´?", bg:"https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ê·¸ë•Œ ì¢‹ì•˜ì§€. ì›ƒì—ˆë„¤.", effect:{love:6,anger:-2,sad:-3}, type:"calm"},
    {text:"ê·¸ ì‚¬ì§„ ì§€ì›Œì¤˜.", effect:{love:-8,anger:8,sad:4}, type:"extreme"},
    {text:"ì‚¬ì§„ì€ ê·¸ëƒ¥ ì¶”ì–µì´ì§€.", effect:{love:2,anger:0,sad:-1}, type:"neutral"}
  ]},
  {title:"ê°‘ì‘ìŠ¤ëŸ° ì•½ì†", text:"ì£¼ë§ì— ì ê¹ ë³¼ë˜? ì–˜ê¸° ì¢€ í•˜ê³  ì‹¶ì–´.", bg:"https://images.unsplash.com/photo-1508923567004-3a6b8004f3d1?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1531123414780-fc3e6b8da0c9?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ì¢‹ì•„, ë§Œë‚˜ì.", effect:{love:10,anger:-3,sad:-5}, type:"calm"},
    {text:"ì•„ë‹ˆ, ì•„ì§ì€ ë¬´ë¦¬ì•¼.", effect:{love:-6,anger:2,sad:6}, type:"neutral"},
    {text:"ì™œ ìê¾¸ ì—°ë½í•´? ì§€ê¸‹ì§€ê¸‹í•´.", effect:{love:-12,anger:12,sad:8}, type:"extreme"}
  ]},
  {title:"ì†”ì§í•œ ê³ ë°±", text:"ê·¸ë™ì•ˆ ë­”ê°€ ì˜ëª»í–ˆë˜ ê²ƒ ê°™ì•„. ë¯¸ì•ˆí•´.", bg:"https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1545996124-1b5e9b1b7a2c?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ì‚¬ì‹¤ ë‚˜ë„ ë¯¸ì•ˆí•œ ì  ìˆì–´.", effect:{love:8,anger:-3,sad:-2}, type:"calm"},
    {text:"ì´ì œ ì™€ì„œ ë¬´ìŠ¨ ì†Œìš©ì´ì•¼.", effect:{love:-10,anger:8,sad:6}, type:"extreme"},
    {text:"ì‹œê°„ì„ ê°–ì. ì²œì²œíˆ ì´ì•¼ê¸°í•˜ì.", effect:{love:2,anger:-1,sad:1}, type:"neutral"}
  ]},
  {title:"ìƒˆ ì—°ì•  ë£¨ë¨¸", text:"í˜¹ì‹œ ë„ˆ ë‚´ SNSì— ìƒˆ ì‚¬ëŒ ìˆë˜ë°?", bg:"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1544006659-f0b21884ce1d?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ê·¸ê±´ ì˜¤í•´ì•¼. ì„¤ëª…í• ê²Œ.", effect:{love:4,anger:-2,sad:-2}, type:"calm"},
    {text:"ê·¸ë˜, ë„ˆëŠ” ì–´ë–»ê²Œ ìƒê°í•˜ë“  ì‹ ê²½ ì•ˆì¨.", effect:{love:-2,anger:4,sad:6}, type:"neutral"},
    {text:"ê±°ì§“ë§ í•˜ì§€ë§ˆ. ë°°ì‹ ê° ë“¤ì–´.", effect:{love:-12,anger:14,sad:6}, type:"extreme"}
  ]},
  {title:"ì•½ì† íŒŒê¸°", text:"ê·¸ë‚  ë„¤ê°€ ì•ˆ ì™€ì„œ ë§ì´ ìƒì²˜ë°›ì•˜ì–´.", bg:"https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ê·¸ë• ì •ë§ ì‚¬ì •ì´ ìˆì—ˆì–´. ë¯¸ì•ˆ.", effect:{love:6,anger:-3,sad:-2}, type:"calm"},
    {text:"ê·¸ëŸ° ì¼ë¡œ ê°ì • ì†Œëª¨í•˜ì§€ë§ˆ.", effect:{love:-4,anger:2,sad:4}, type:"neutral"},
    {text:"ë„¤ê°€ ê³¼ë¯¼ë°˜ì‘ì´ì•¼. ê°ì • ì¡°ì ˆí•´.", effect:{love:-10,anger:10,sad:6}, type:"extreme"}
  ]},
  {title:"ê°‘ìê¸° ë“¤ì´ëŒ", text:"ì˜¤ëŠ˜ ìš°ì—°íˆ ë³´ë‹ˆê¹Œ ë„¤ê°€ ë„ˆë¬´ ì˜ˆë» ë³´ì˜€ì–´.", bg:"https://images.unsplash.com/photo-1519331379826-2929d1fbdc1b?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1545996124-1b5e9b1b7a2c?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ê³ ë§ˆì›Œ. ë„ˆë„ ì˜ ì§€ë‚´.", effect:{love:6,anger:-1,sad:-1}, type:"calm"},
    {text:"ê·¸ëŸ° ë§ ê°‘ìê¸° ì™œ í•´?", effect:{love:-2,anger:2,sad:2}, type:"neutral"},
    {text:"ê·¸ë§Œ ì¢€ í•´. ë¶ˆí¸í•´.", effect:{love:-8,anger:8,sad:4}, type:"extreme"}
  ]},
  {title:"ê¹Šì€ ëŒ€í™”", text:"ì„œë¡œ ì†”ì§í•´ì§ˆ ìˆ˜ ìˆì„ê¹Œ? ë„¤ ê°ì •ì´ ê¶ê¸ˆí•´.", bg:"https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ë‚œ ì•„ì§ ë„ ì¢‹ì•„í•´.", effect:{love:12,anger:-4,sad:-6}, type:"calm"},
    {text:"ì¢‹ì•„í–ˆì§€ë§Œ ì´ì œ ë.", effect:{love:-8,anger:4,sad:10}, type:"neutral"},
    {text:"ë‹¤ì‹  ê·¸ëŸ° ë§ í•˜ì§€ë§ˆ.", effect:{love:-14,anger:12,sad:8}, type:"extreme"}
  ]},
  {title:"ì˜¤í•´ì˜ ì¦í­", text:"ì¹œêµ¬ë“¤ì´ ë„¤ ì–˜ê¸°í•˜ë”ë¼. ìƒì²˜ë°›ì•˜ì–´.", bg:"https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ê·¸ëŸ° ì–˜ê¸´ ë¬´ìŠ¨... ì˜¤í•´ì•¼.", effect:{love:4,anger:-2,sad:-2}, type:"calm"},
    {text:"ê·¸ë§Œ ì¢€ í•´. ë” ì´ìƒ ëª» ì°¸ì•„.", effect:{love:-10,anger:12,sad:6}, type:"extreme"},
    {text:"ì¦ê±° ë³´ì—¬ì¤˜. ë§ë¡œ ëª» ë¯¿ê² ì–´.", effect:{love:-2,anger:4,sad:2}, type:"neutral"}
  ]},
  {title:"ë°¤ì˜ ê³ ë°±", text:"ë‹¬ì´ ì˜ˆë»ì„œ ë„ˆ ìƒê°ë‚¬ì–´...", bg:"https://images.unsplash.com/photo-1504198453319-5ce911bafcde?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ë‚˜ë„ ë„¤ ìƒê° ìì£¼ í•´.", effect:{love:10,anger:-3,sad:-4}, type:"calm"},
    {text:"ì´ëŸ° ë§ë¡œ ë‹¤ì‹œ í˜¼ë€ìŠ¤ëŸ½ê²Œ í•˜ì§€ë§ˆ.", effect:{love:-8,anger:6,sad:6}, type:"extreme"},
    {text:"ê·¸ë•Œë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆì„ê¹Œ?", effect:{love:4,anger:-1,sad:2}, type:"neutral"}
  ]},
  {title:"ì„œë¡œì˜ ë³€í™”", text:"ìš°ë¦° ë§ì´ ë‹¬ë¼ì¡Œì–´. ë„ˆëŠ” ì–´ë•Œ?", bg:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1544006659-f0b21884ce1d?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ì„œë¡œ ë” ì„±ìˆ™í•´ì§„ ê²ƒ ê°™ì•„.", effect:{love:6,anger:-2,sad:-1}, type:"calm"},
    {text:"ë³€í•œ ê±´ ë„¤ê°€ ë” ë³€í•œ ê²ƒ ê°™ì•„.", effect:{love:-6,anger:6,sad:4}, type:"neutral"},
    {text:"ë‹¤ì‹œëŠ” ì—°ê²°ë˜ì§€ ì•Šì•˜ìœ¼ë©´ í•´.", effect:{love:-12,anger:8,sad:10}, type:"extreme"}
  ]},
  {title:"ì‘ê¸‰ ìƒí™©", text:"ê¸‰í•œ ì¼ì´ ìƒê²¼ì–´, ë„ì™€ì¤„ ìˆ˜ ìˆì–´?", bg:"https://images.unsplash.com/photo-1508830524289-0adcbe822b40?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1531123414780-fc3e6b8da0c9?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ë‹¹ì—°íˆ ë„ì™€ì¤„ê²Œ.", effect:{love:8,anger:-3,sad:-2}, type:"calm"},
    {text:"ì§€ê¸ˆì€ ë‚´ê°€ í˜ë“¤ì–´.", effect:{love:-4,anger:2,sad:6}, type:"neutral"},
    {text:"ê·¸ëŸ° ê±´ ë‚´ ë¬¸ì œê°€ ì•„ë‹ˆì•¼.", effect:{love:-12,anger:10,sad:6}, type:"extreme"}
  ]},
  {title:"ê²°ì •ì˜ ìˆœê°„", text:"ìš°ë¦¬ ì´ëŒ€ë¡œ ì¹œêµ¬ë¡œ ì§€ë‚¼ë˜, ì•„ë‹ˆë©´...?", bg:"https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1545996124-1b5e9b1b7a2c?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ì¹œêµ¬ë¡œ ì§€ë‚´ì. ì²œì²œíˆ.", effect:{love:4,anger:-2,sad:1}, type:"calm"},
    {text:"ë‹¤ì‹œ ì‹œì‘í•´ë³´ê³  ì‹¶ì–´.", effect:{love:14,anger:-4,sad:-6}, type:"calm"},
    {text:"ëë‚´ì. ì™„ì „íˆ.", effect:{love:-14,anger:8,sad:8}, type:"extreme"}
  ]},
  {title:"ë§ˆì§€ë§‰ ë©”ì‹œì§€", text:"ë§ˆì§€ë§‰ìœ¼ë¡œ í•´ë‘ê³  ì‹¶ì€ ë§ì´ ìˆì–´.", bg:"https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&w=1400&q=80", npc:"https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&q=80", choices:[
    {text:"ë‚œ ë„¤ê°€ í–‰ë³µí•˜ê¸¸ ë°”ë„ê²Œ.", effect:{love:10,anger:-4,sad:-3}, type:"calm"},
    {text:"ê·¸ëŸ´ ì‹œê°„ì´ ì§€ë‚¬ë‹¤.", effect:{love:-6,anger:6,sad:6}, type:"neutral"},
    {text:"ì•ˆë…•. ë‹¤ì‹œ ë³´ì§€ ë§ì.", effect:{love:-12,anger:8,sad:10}, type:"extreme"}
  ]}
];

// ìƒíƒœ
let state = {
  idx: 0,
  love: 50, anger: 10, sad: 20,
  history: []
};

const maxStages = scenes.length;

/* DOM */
const bg = document.getElementById('bg');
const chat = document.getElementById('chat');
const choices = document.getElementById('choices');
const sceneTitle = document.getElementById('sceneTitle');
const sceneInfo = document.getElementById('sceneInfo');
const loveBar = document.getElementById('loveBar');
const angerBar = document.getElementById('angerBar');
const sadBar = document.getElementById('sadBar');
const progressFill = document.getElementById('progressFill');
const stageText = document.getElementById('stageText');
const endingEl = document.getElementById('ending');
const endingTitle = document.getElementById('endingTitle');
const endingDesc = document.getElementById('endingDesc');

const autoBtn = document.getElementById('autoPlay');
let autoPlayTimer = null;

/* ì €ì¥/ë¡œë“œ */
function saveState(){
  localStorage.setItem('exsim_state', JSON.stringify(state));
  alert('ì§„í–‰ ìƒíƒœê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function loadState(){
  const s = localStorage.getItem('exsim_state');
  if(s){ state = JSON.parse(s); return true; } 
  return false;
}
function clearState(){
  localStorage.removeItem('exsim_state');
  alert('ì €ì¥ëœ ìƒíƒœë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
}

/* UI ì—…ë°ì´íŠ¸ */
function updateUI(){
  const sc = scenes[state.idx];
  bg.style.backgroundImage = `url('${sc.bg}')`;
  sceneTitle.textContent = sc.title;
  sceneInfo.textContent = `Stage ${state.idx+1} / ${maxStages}`;
  stageText.textContent = `${state.idx+1} / ${maxStages}`;
  loveBar.style.width = clamp(state.love,0,100) + '%';
  angerBar.style.width = clamp(state.anger,0,100) + '%';
  sadBar.style.width = clamp(state.sad,0,100) + '%';
  progressFill.style.width = Math.round(((state.idx)/ (maxStages)) * 100) + '%';
}

/* show scene */
function renderScene(){
  updateUI();
  chat.innerHTML = '';
  // show NPC message
  const sc = scenes[state.idx];
  appendNpc(sc.npc, sc.text);
  // render choices
  choices.innerHTML = '';
  sc.choices.forEach((c, i) => {
    const btn = document.createElement('button');
    btn.textContent = c.text;
    btn.className = c.type === 'extreme' ? 'extreme' : (c.type==='calm' ? 'calm' : '');
    btn.onclick = () => { applyChoice(c) };
    choices.appendChild(btn);
  });
}

/* append functions */
function appendNpc(imgUrl, text){
  const div = document.createElement('div');
  div.className = 'npc-msg';
  const img = document.createElement('img'); img.src = imgUrl + '&q=60';
  const span = document.createElement('div'); span.textContent = text;
  div.appendChild(img); div.appendChild(span);
  chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
}
function appendPlayer(text){
  const div = document.createElement('div');
  div.className = 'player-msg';
  div.textContent = text;
  chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
}

/* apply choice */
function applyChoice(choice){
  // update emotions
  state.love = state.love + (choice.effect.love || 0);
  state.anger = state.anger + (choice.effect.anger || 0);
  state.sad = state.sad + (choice.effect.sad || 0);
  // clamp
  state.love = clamp(state.love, 0, 150);
  state.anger = clamp(state.anger, 0, 150);
  state.sad = clamp(state.sad, 0, 150);
  // record
  state.history.push({
    idx: state.idx,
    scene: scenes[state.idx].title,
    choice: choice.text,
    emotions: {love: state.love, anger: state.anger, sad: state.sad}
  });
  appendPlayer(choice.text);
  // advance
  state.idx++;
  if(state.idx >= maxStages){
    setTimeout(()=> showEnding(), 700);
  } else {
    setTimeout(()=> renderScene(), 600);
  }
}

/* ending logic */
function showEnding(){
  // Decide ending by weighted emotions
  // Happy: love significantly higher than sadness & anger
  // Cold: anger high
  // Tear: sad high
  const L = state.love, A = state.anger, S = state.sad;
  let title='', desc='';
  if(L >= S + 20 && L >= A - 5){
    title = 'í•´í”¼ ì—”ë”© ğŸ’—';
    desc = 'ì„œë¡œì˜ ê°ì •ì„ ë‹¤ì‹œ ë³´ë“¬ê³  ë”°ëœ»í•œ ê´€ê³„ë¡œ ë‚˜ì•„ê°‘ë‹ˆë‹¤. ì„±ì¥ê³¼ í™”í•´ì˜ ì‹œê°„.';
  } else if(A >= Math.max(L, S) && A > 35){
    title = 'ëƒ‰ì • ì—”ë”© â„ï¸';
    desc = 'ë¶„ë…¸ì™€ ê±°ë¦¬ê°ì´ ìŒ“ì—¬ ê´€ê³„ëŠ” ì •ë¦¬ë©ë‹ˆë‹¤. ê°ì •ì˜ ê²°ë§ì€ ì°¨ê°‘ìŠµë‹ˆë‹¤.';
  } else if(S >= Math.max(L, A) && S > 40){
    title = 'ëˆˆë¬¼ ì—”ë”© ğŸ’§';
    desc = 'ìƒì²˜ê°€ ê¹Šì–´ ëˆˆë¬¼ë¡œ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤. ì•„í”ˆ ì‹œê°„ì´ì§€ë§Œ ê²°êµ­ì€ íšŒë³µì„ ìœ„í•œ í•œ ê±¸ìŒ.';
  } else {
    title = 'ì—¬ìš´ ì—”ë”© ğŸŒ™';
    desc = 'ê°ì •ì˜ ê²°ì´ ë³µì¡í•˜ê²Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ì•ìœ¼ë¡œë¥¼ í–¥í•´ í•œ ë°œì„ ë‚´ë”›ìŠµë‹ˆë‹¤.';
  }
  endingTitle.textContent = title;
  endingDesc.textContent = `${desc}\n\nìµœì¢… ê°ì •ì¹˜ â€” ì‚¬ë‘: ${L}, ë¶„ë…¸: ${A}, ìŠ¬í””: ${S}`;
  endingEl.style.display = 'flex';
  // stop autoplay if any
  stopAuto();
}

/* helpers */
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

/* download result as text file (ì¼ê¸°í˜•) */
function downloadResult(){
  const lines = [];
  lines.push('ì „ì—°ì¸ ì‹œë®¬ë ˆì´í„° â€” ê²°ê³¼ ì¼ê¸°');
  lines.push('---------------------------------');
  lines.push(`ë‚ ì§œ: ${new Date().toLocaleString()}`);
  lines.push(`ìµœì¢… ìŠ¤í…Œì´ì§€: ${Math.min(state.idx, maxStages)}/${maxStages}`);
  lines.push(`ìµœì¢… ê°ì •ì¹˜: ì‚¬ë‘ ${state.love}, ë¶„ë…¸ ${state.anger}, ìŠ¬í”” ${state.sad}`);
  lines.push('');
  lines.push('ì„ íƒ ê¸°ë¡:');
  state.history.forEach((h, i) => {
    lines.push(`${i+1}. [${h.scene}] -> ${h.choice} (love:${h.emotions.love}, anger:${h.emotions.anger}, sad:${h.emotions.sad})`);
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'exsim_result.txt'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
}

/* autoplay */
function startAuto(){
  if(autoPlayTimer) return;
  autoBtn.textContent = 'ìë™ ì¤‘ì§€';
  autoPlayTimer = setInterval(()=>{
    // pick the calm choice if love high, else extreme neutral/random
    const sc = scenes[state.idx];
    if(!sc) { stopAuto(); return; }
    // heuristic: if love is high, prefer calm; if anger high, prefer extreme to resolve; else random
    let pickIdx = 0;
    if(state.love > 70){
      pickIdx = sc.choices.findIndex(c=>c.type==='calm'); if(pickIdx<0) pickIdx = 0;
    } else if(state.anger > 40){
      pickIdx = sc.choices.findIndex(c=>c.type==='extreme'); if(pickIdx<0) pickIdx = Math.floor(Math.random()*sc.choices.length);
    } else {
      pickIdx = Math.floor(Math.random()*sc.choices.length);
    }
    applyChoice(sc.choices[pickIdx]);
    if(state.idx >= maxStages) stopAuto();
  }, 900);
}
function stopAuto(){ if(autoPlayTimer){ clearInterval(autoPlayTimer); autoPlayTimer=null; autoBtn.textContent='ìë™ ì§„í–‰'; } }

/* event bindings */
document.getElementById('saveBtn').onclick = saveState;
document.getElementById('restartBtn').onclick = () => { if(confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ë˜ìš”? ì €ì¥ëœ ìƒíƒœëŠ” ì§€ì›Œì§‘ë‹ˆë‹¤.')) { state = {idx:0,love:50,anger:10,sad:20,history:[]}; localStorage.removeItem('exsim_state'); renderScene(); endingEl.style.display='none'; } };
document.getElementById('downloadBtn').onclick = downloadResult;
document.getElementById('clearBtn').onclick = () => { if(confirm('ì €ì¥ëœ ì§„í–‰ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) { clearState(); } };
document.getElementById('autoPlay').onclick = ()=>{ if(autoPlayTimer) stopAuto(); else startAuto(); };
document.getElementById('restart2').onclick = ()=>{ endingEl.style.display='none'; state = {idx:0,love:50,anger:10,sad:20,history:[]}; localStorage.removeItem('exsim_state'); renderScene(); };
document.getElementById('download2').onclick = ()=>{ downloadResult(); };

window.addEventListener('load', ()=>{
  // try load saved state
  const loaded = loadState();
  if(loaded){
    if(confirm('ì €ì¥ëœ ì§„í–‰ì„ ë¶ˆëŸ¬ì˜¬ê²Œìš”. ì´ì–´ì„œ í•˜ì‹œê² ì–´ìš”?')) {
      renderScene(); return;
    } else {
      localStorage.removeItem('exsim_state');
      state = {idx:0,love:50,anger:10,sad:20,history:[]};
    }
  }
  renderScene();
});

/* before unload save automatically */
window.addEventListener('beforeunload', ()=>{ localStorage.setItem('exsim_state', JSON.stringify(state)); });
</script>
</body>
</html>
